---
title: "R Notebook"
---
```{r}
setwd("C:/Users/iris9/BioTrajX")
devtools::load_all() 
```

```{r}
library(Seurat)
seu <- readRDS("C:/Users/iris9/Desktop/bone_marrow_10X_pseudotime.rds")


DimPlot(seu, group.by = "Phenotype")
FeaturePlot(seu, features="monocle3_pseudotime")
FeaturePlot(seu, features="slingshot_pt_single")
FeaturePlot(seu, features="CytoTRACE")
```

```{r}
stem_progenitor_genes <- c(
  "Cd34",
  "Kit",        # c-Kit
  "Flt3",
  "Prom1",      # CD133
  "Thy1",       # CD90
  "Hoxb4",
  "Gata2",
  "Runx1",
  "Tal1",
  "Mecom"       # aka Evi1
)

# Erythrocyte / erythroid markers
erythrocyte_genes <- c(
  "Gypa",       # Glycophorin A
  "Hbb-bs",     # Hemoglobin, beta, adult minor chain
  "Hbb-bt",     # Hemoglobin, beta, major chain
  "Hba-a1",     # Hemoglobin alpha, adult
  "Hba-a2",     # Hemoglobin alpha, adult
  "Tfrc",       # CD71, transferrin receptor
  "Klf1",       # Erythroid transcription factor
  "Alas2",      # Heme biosynthesis
  "Epor",       # Erythropoietin receptor
  "Gata1"       # Master erythroid TF
)

pseudotime_methods <- list(
  "monocle3" = seu$monocle3_pseudotime,
  "slingshot" = seu$slingshot_pt_single, 
  "CytoTRACE" = seu$CytoTRACE
)

expr <- as.matrix(GetAssayData(seu, layer = "data"))


results <- compute_multi_DOPE_linear(
  expr = expr,
  pseudotime_list = pseudotime_methods,
  naive_markers = stem_progenitor_genes ,
  species = "Mus musculus",
  tol = 0.01,
  terminal_markers = erythrocyte_genes,
  pathways = c("mmu04640"),
  E_method = "gmm", plot_E = T
)
```
```{r}
plot.multi_dope_results (results, type = "bar")

plot.multi_dope_results (results, type = "radar")
plot.multi_dope_results (results, type = "heatmap")
```

Selecting the erythrocyte and B cell lineages 
```{r}
branches <- c("Stem_to_Ery","Stem_to_B")
naive_markers_list <- list(
 Stem_to_Ery = stem_progenitor_genes,
 Stem_to_B = stem_progenitor_genes)

terminal_markers_list <- list(
 Stem_to_Ery = erythrocyte_genes,
 Stem_to_B = c("Cd19","Cd79a","Cd79b","Ms4a1","Cd22","Cr2","Fcer2a","Pax5","Ebf1","Irf4"))

pathways_list <- list(
   Stem_to_Ery = c("mmu04640"),
   Stem_to_B = c("mmu04662")
)

branch_filters <- list(
 Stem_to_Ery = list(include = c("Stem_Progenitors","Megakaryocyte_progenitors", "Erythroid_progenitors_Erythroblasts", "Erythrocytes"), min_cells = 50),
  Stem_to_B = list(include = c("Stem_Progenitors","Immature_B", "Mature_B"), min_cells = 50))

res_multi <- compute_multi_DOPE_branched(
  expr_or_seurat = seu,
  pseudotime_list = pseudotime_methods,
  naive_markers_list = naive_markers_list,
  terminal_markers_list = terminal_markers_list,
  pathways_list = pathways_list,
  cluster_labels = "Phenotype",
  branch_filters = branch_filters,
  id_type = "SYMBOL",
  species = "Mus musculus",
  verbose = TRUE
)
```
```{r}
res_single_br <- compute_single_DOPE_branched(
  expr_or_seurat = seu,
  pseudotime = pseudotime_methods$monocle3,
  naive_markers_list = naive_markers_list,
  terminal_markers_list = terminal_markers_list,
  pathways_list = pathways_list,
  cluster_labels = "Phenotype",
  branch_filters = branch_filters,
  id_type = "SYMBOL",
  species = "Mus musculus",
  verbose = TRUE
)
```
```{r}
plot.multi_dope_results_branched(res_multi, branch_mode= "facet")
```
```{r}
res <- res_multi

# 1) Overall aggregate DOPE across trajectories
plot.multi_dope_results_branched(res, scope = "overall", type = "bar")

# 2) Per-branch bar plot, faceted by branch
plot.multi_dope_results_branched(res, scope = "branch",
                                 metrics = c("D_naive","D_term","O","P","E_naive", "E_term","DOPE_score"),
                                 type = "bar", branch_mode = "facet")

# 3) Per-branch heatmap with stacked labels "trajectory [branch]"
plot.multi_dope_results_branched(res, scope = "branch",
                                 type = "heatmap", branch_mode = "stack")

# 4) Separate radar per branch
plot.multi_dope_results_branched(res, scope = "branch",
                                 type = "radar", branch_mode = "separate")


```


